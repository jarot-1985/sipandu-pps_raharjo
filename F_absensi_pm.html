import React, { useState, useEffect, useMemo, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getFirestore, 
  collection, 
  doc, 
  onSnapshot, 
  addDoc, 
  updateDoc, 
  deleteDoc
} from 'firebase/firestore';
import { 
  getAuth, 
  signInWithCustomToken, 
  signInAnonymously, 
  onAuthStateChanged 
} from 'firebase/auth';
import { 
  Save, 
  Trash2, 
  Edit3, 
  Loader2, 
  Plus, 
  Search, 
  LayoutGrid, 
  Users,
  Filter,
  UserCheck,
  UserMinus,
  ChevronDown,
  Building2,
  FileText,
  UploadCloud,
  X,
  Eye,
  Download,
  RefreshCcw,
  CheckCircle2,
  AlertCircle,
  MoreHorizontal,
  CalendarDays
} from 'lucide-react';

const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'pm-absensi-v3';

export default function App() {
  const [activeTab, setActiveTab] = useState('history');
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [listAbsensi, setListAbsensi] = useState([]);
  const [editId, setEditId] = useState(null);
  const [xlsxLoaded, setXlsxLoaded] = useState(false);
  const fileInputRef = useRef(null);
  const [toast, setToast] = useState({ show: false, message: '', type: 'success' });

  // Filter States
  const [searchUnit, setSearchUnit] = useState('Semua');
  const [filterPeriode, setFilterPeriode] = useState('Semua');

  const [form, setForm] = useState({
    unitPelayanan: '',
    bulanTahun: '',
    periodeLaporan: '',
    pmLaki: '',
    pmPerempuan: '',
    totalPm: 0,
    keterangan: '',
    pdfData: null,
    pdfName: ''
  });

  const unitOptions = [
    "PPSDI Raharjo Sragen", 
    "RPSLU Mojomulyo Sragen", 
    "RPSA Pamardi Siwi Sragen", 
    "RPS PMKS Gondang"
  ];
  
  const periodeOptions = ["I (Satu)", "II (Dua)", "III (Tiga)"];

  const showToast = (message, type = 'success') => {
    setToast({ show: true, message, type });
    setTimeout(() => setToast({ show: false, message: '', type: 'success' }), 3000);
  };

  useEffect(() => {
    const script = document.createElement('script');
    script.src = "https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js";
    script.async = true;
    script.onload = () => setXlsxLoaded(true);
    document.body.appendChild(script);
  }, []);

  useEffect(() => {
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, (u) => {
      setUser(u);
      setLoading(false);
    });
    return () => unsubscribe();
  }, []);

  useEffect(() => {
    if (!user) return;
    const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'absensi_pm');
    const unsubscribe = onSnapshot(colRef, 
      (snapshot) => {
        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        setListAbsensi(data.sort((a, b) => (b.updatedAt || 0) - (a.updatedAt || 0)));
      },
      (err) => console.error("Firestore error:", err)
    );
    return () => unsubscribe();
  }, [user]);

  useEffect(() => {
    const laki = parseInt(form.pmLaki) || 0;
    const perempuan = parseInt(form.pmPerempuan) || 0;
    setForm(prev => ({ ...prev, totalPm: laki + perempuan }));
  }, [form.pmLaki, form.pmPerempuan]);

  const handleFileUpload = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    if (file.type !== 'application/pdf') {
      showToast("Hanya file PDF yang diizinkan", "error");
      return;
    }
    const reader = new FileReader();
    reader.onload = (event) => {
      setForm(prev => ({ ...prev, pdfData: event.target.result, pdfName: file.name }));
      showToast("File PDF berhasil dimuat");
    };
    reader.readAsDataURL(file);
  };

  const removePdf = () => {
    setForm(prev => ({ ...prev, pdfData: null, pdfName: '' }));
    if (fileInputRef.current) fileInputRef.current.value = "";
    showToast("Lampiran PDF dihapus", "error");
  };

  const openPdf = (base64) => {
    const win = window.open();
    if (win) {
      win.document.write(`<iframe src="${base64}" frameborder="0" style="border:0; top:0px; left:0px; bottom:0px; right:0px; width:100%; height:100%;" allowfullscreen></iframe>`);
    } else {
      showToast("Pop-up diblokir oleh browser", "error");
    }
  };

  const filteredData = useMemo(() => {
    return listAbsensi.filter(item => {
      const matchUnit = searchUnit === 'Semua' || item.unitPelayanan === searchUnit;
      const matchPeriode = filterPeriode === 'Semua' || item.periodeLaporan === filterPeriode;
      return matchUnit && matchPeriode;
    });
  }, [listAbsensi, searchUnit, filterPeriode]);

  const stats = useMemo(() => {
    return filteredData.reduce((acc, curr) => ({
      laki: acc.laki + (parseInt(curr.pmLaki) || 0),
      perempuan: acc.perempuan + (parseInt(curr.pmPerempuan) || 0),
      total: acc.total + (parseInt(curr.totalPm) || 0)
    }), { laki: 0, perempuan: 0, total: 0 });
  }, [filteredData]);

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!user) return;
    try {
      const payload = { ...form, updatedAt: Date.now() };
      const colPath = ['artifacts', appId, 'public', 'data', 'absensi_pm'];
      if (editId) {
        await updateDoc(doc(db, ...colPath, editId), payload);
        showToast("Data berhasil diperbarui!");
        setEditId(null);
      } else {
        await addDoc(collection(db, ...colPath), payload);
        showToast("Data baru berhasil disimpan!");
      }
      setForm({ unitPelayanan: '', bulanTahun: '', periodeLaporan: '', pmLaki: '', pmPerempuan: '', totalPm: 0, keterangan: '', pdfData: null, pdfName: '' });
      setActiveTab('history');
    } catch (err) {
      showToast("Terjadi kesalahan saat menyimpan", "error");
    }
  };

  const handleDelete = async (id) => {
    if (window.confirm("Hapus data laporan ini?")) {
      try {
        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'absensi_pm', id));
        showToast("Data berhasil dihapus", "error");
      } catch (err) {
        showToast("Gagal menghapus data", "error");
      }
    }
  };

  if (loading) return (
    <div className="flex h-screen items-center justify-center bg-slate-50">
      <Loader2 className="animate-spin text-indigo-600" size={32} />
    </div>
  );

  return (
    <div className="min-h-screen bg-[#F8FAFC] pb-24 text-slate-800 font-sans">
      {/* Toast */}
      {toast.show && (
        <div className={`fixed top-6 left-1/2 -translate-x-1/2 z-[60] flex items-center gap-3 px-6 py-4 rounded-2xl shadow-2xl border transition-all animate-in fade-in slide-in-from-top-4 duration-300 ${
          toast.type === 'success' ? 'bg-indigo-600 border-indigo-400 text-white' : 'bg-rose-600 border-rose-400 text-white'
        }`}>
          {toast.type === 'success' ? <CheckCircle2 size={20} /> : <AlertCircle size={20} />}
          <span className="text-sm font-bold">{toast.message}</span>
        </div>
      )}

      <header className="bg-white border-b border-slate-200 sticky top-0 z-40 px-6 py-4 shadow-sm">
        <div className="max-w-[1400px] mx-auto flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="p-2 bg-indigo-600 rounded-lg shadow-lg shadow-indigo-100">
               <Users className="text-white" size={20} />
            </div>
            <h1 className="text-lg font-bold tracking-tight text-slate-900">ABSENSI PM</h1>
          </div>
          {activeTab === 'history' && (
            <button 
              onClick={() => {
                const dataToExport = filteredData.map(item => ({
                  'Unit': item.unitPelayanan,
                  'Bulan': item.bulanTahun,
                  'Periode': item.periodeLaporan,
                  'L': item.pmLaki,
                  'P': item.pmPerempuan,
                  'Total': item.totalPm,
                  'Keterangan': item.keterangan
                }));
                const ws = window.XLSX.utils.json_to_sheet(dataToExport);
                const wb = window.XLSX.utils.book_new();
                window.XLSX.utils.book_append_sheet(wb, ws, "Data");
                window.XLSX.writeFile(wb, "Laporan_PM.xlsx");
                showToast("Data diekspor!");
              }}
              className="flex items-center gap-2 px-4 py-2 bg-emerald-600 text-white rounded-xl font-bold text-xs hover:bg-emerald-700 transition-all shadow-lg shadow-emerald-100"
            >
              <Download size={16} />
              <span>Ekspor Excel</span>
            </button>
          )}
        </div>
      </header>

      <main className="max-w-[1400px] mx-auto p-4 md:p-6 space-y-6">
        
        {activeTab === 'input' ? (
          <div className="max-w-2xl mx-auto bg-white rounded-3xl shadow-sm border border-slate-200 p-8">
            <h2 className="text-xl font-bold text-slate-900 mb-6 flex items-center gap-2">
              <div className="w-1 h-6 bg-indigo-600 rounded-full"></div>
              {editId ? 'Edit Laporan' : 'Tambah Laporan Baru'}
            </h2>
            <form onSubmit={handleSubmit} className="space-y-5">
              <div className="space-y-1.5">
                <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-1">Unit Pelayanan</label>
                <select value={form.unitPelayanan} onChange={e=>setForm({...form, unitPelayanan: e.target.value})} className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500/20 font-medium" required>
                  <option value="">Pilih Unit</option>
                  {unitOptions.map(o=><option key={o} value={o}>{o}</option>)}
                </select>
              </div>
              <div className="grid grid-cols-2 gap-4">
                <div className="space-y-1.5">
                  <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-1">Bulan/Tahun</label>
                  <input type="month" value={form.bulanTahun} onChange={e=>setForm({...form, bulanTahun: e.target.value})} className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none" required />
                </div>
                <div className="space-y-1.5">
                  <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-1">Periode</label>
                  <select value={form.periodeLaporan} onChange={e=>setForm({...form, periodeLaporan: e.target.value})} className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none" required>
                    <option value="">Pilih Periode</option>
                    {periodeOptions.map(o=><option key={o} value={o}>{o}</option>)}
                  </select>
                </div>
              </div>
              <div className="grid grid-cols-2 gap-4">
                <div className="p-3 bg-blue-50/50 rounded-xl border border-blue-100">
                  <label className="text-[10px] font-bold text-blue-500 uppercase block mb-1">PM Laki-Laki</label>
                  <input type="number" value={form.pmLaki} onChange={e=>setForm({...form, pmLaki: e.target.value})} placeholder="0" className="w-full bg-transparent text-xl font-bold outline-none text-blue-700" required />
                </div>
                <div className="p-3 bg-rose-50/50 rounded-xl border border-rose-100">
                  <label className="text-[10px] font-bold text-rose-500 uppercase block mb-1">PM Perempuan</label>
                  <input type="number" value={form.pmPerempuan} onChange={e=>setForm({...form, pmPerempuan: e.target.value})} placeholder="0" className="w-full bg-transparent text-xl font-bold outline-none text-rose-700" required />
                </div>
              </div>
              <div className="space-y-1.5">
                <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-1">Keterangan</label>
                <textarea value={form.keterangan} onChange={e=>setForm({...form, keterangan: e.target.value})} className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl min-h-[80px] outline-none" placeholder="Catatan..."></textarea>
              </div>
              <div className="space-y-1.5">
                <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-1">Lampiran PDF</label>
                {!form.pdfData ? (
                  <div onClick={()=>fileInputRef.current.click()} className="border-2 border-dashed border-slate-200 p-6 rounded-xl text-center cursor-pointer hover:bg-slate-50 transition-all">
                    <UploadCloud className="mx-auto text-slate-300 mb-2" />
                    <p className="text-xs font-bold text-slate-500">Upload Laporan PDF</p>
                    <input ref={fileInputRef} type="file" accept=".pdf" onChange={handleFileUpload} className="hidden" />
                  </div>
                ) : (
                  <div className="flex items-center justify-between p-3 bg-indigo-50 border border-indigo-100 rounded-xl">
                    <div className="flex items-center gap-2 overflow-hidden">
                      <FileText className="text-indigo-600 shrink-0" size={18} />
                      <span className="text-xs font-bold text-indigo-900 truncate">{form.pdfName}</span>
                    </div>
                    <button type="button" onClick={removePdf} className="text-rose-500 p-1 hover:bg-rose-100 rounded-md"><X size={16} /></button>
                  </div>
                )}
              </div>
              <button type="submit" className="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition-all flex items-center justify-center gap-2">
                <Save size={18} /> {editId ? 'Update Laporan' : 'Simpan Laporan'}
              </button>
            </form>
          </div>
        ) : (
          <div className="space-y-6">
            {/* Stats */}
            <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
              <div className="bg-white p-5 rounded-2xl border border-slate-200 flex items-center gap-4">
                <div className="w-12 h-12 bg-indigo-50 rounded-xl flex items-center justify-center text-indigo-600"><Users size={24}/></div>
                <div><p className="text-[10px] font-bold text-slate-400 uppercase">Total PM</p><p className="text-2xl font-black">{stats.total}</p></div>
              </div>
              <div className="bg-white p-5 rounded-2xl border border-slate-200 flex items-center gap-4">
                <div className="w-12 h-12 bg-blue-50 rounded-xl flex items-center justify-center text-blue-600"><UserCheck size={24}/></div>
                <div><p className="text-[10px] font-bold text-slate-400 uppercase">Laki-Laki</p><p className="text-2xl font-black text-blue-600">{stats.laki}</p></div>
              </div>
              <div className="bg-white p-5 rounded-2xl border border-slate-200 flex items-center gap-4">
                <div className="w-12 h-12 bg-rose-50 rounded-xl flex items-center justify-center text-rose-600"><UserMinus size={24}/></div>
                <div><p className="text-[10px] font-bold text-slate-400 uppercase">Perempuan</p><p className="text-2xl font-black text-rose-600">{stats.perempuan}</p></div>
              </div>
            </div>

            {/* Filter Bar */}
            <div className="bg-white p-3 rounded-2xl border border-slate-200 flex flex-wrap items-center gap-3">
              <div className="flex-1 min-w-[200px] relative">
                <Building2 className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={16} />
                <select value={searchUnit} onChange={e=>setSearchUnit(e.target.value)} className="w-full pl-10 pr-4 py-2 bg-slate-50 rounded-xl text-xs font-bold outline-none border border-transparent focus:border-indigo-300 transition-all appearance-none">
                  <option value="Semua">Semua Unit</option>
                  {unitOptions.map(o=><option key={o} value={o}>{o}</option>)}
                </select>
              </div>
              <div className="flex-1 min-w-[200px] relative">
                <CalendarDays className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={16} />
                <select value={filterPeriode} onChange={e=>setFilterPeriode(e.target.value)} className="w-full pl-10 pr-4 py-2 bg-slate-50 rounded-xl text-xs font-bold outline-none border border-transparent focus:border-indigo-300 transition-all appearance-none">
                  <option value="Semua">Semua Periode</option>
                  {periodeOptions.map(o=><option key={o} value={o}>Periode {o}</option>)}
                </select>
              </div>
              <button onClick={()=>{setSearchUnit('Semua'); setFilterPeriode('Semua');}} className="px-4 py-2 text-slate-400 hover:text-indigo-600 font-bold text-xs flex items-center gap-2 transition-all"><RefreshCcw size={14}/> Reset</button>
            </div>

            {/* Data Table - Horizontal/Berjajar */}
            <div className="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
               <div className="overflow-x-auto">
                 <table className="w-full text-left border-collapse min-w-[1000px]">
                    <thead>
                       <tr className="bg-slate-50/50 border-b border-slate-100">
                          <th className="px-6 py-4 text-[10px] font-bold text-slate-400 uppercase tracking-widest w-[25%]">Unit Pelayanan</th>
                          <th className="px-4 py-4 text-[10px] font-bold text-slate-400 uppercase tracking-widest text-center">Bulan/Thn</th>
                          <th className="px-4 py-4 text-[10px] font-bold text-slate-400 uppercase tracking-widest text-center">Periode</th>
                          <th className="px-4 py-4 text-[10px] font-bold text-slate-400 uppercase tracking-widest text-center">Rincian L/P</th>
                          <th className="px-4 py-4 text-[10px] font-bold text-slate-400 uppercase tracking-widest text-center">Total</th>
                          <th className="px-6 py-4 text-[10px] font-bold text-slate-400 uppercase tracking-widest">Keterangan</th>
                          <th className="px-4 py-4 text-[10px] font-bold text-slate-400 uppercase tracking-widest text-center">Lampiran</th>
                          <th className="px-6 py-4 text-[10px] font-bold text-slate-400 uppercase tracking-widest text-right sticky right-0 bg-slate-50 sm:bg-transparent">Aksi</th>
                       </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-50">
                       {filteredData.map(item => (
                         <tr key={item.id} className="hover:bg-indigo-50/30 transition-colors group">
                            <td className="px-6 py-4">
                               <span className="font-bold text-slate-900 text-sm">{item.unitPelayanan}</span>
                            </td>
                            <td className="px-4 py-4 text-center">
                               <span className="text-xs font-medium text-slate-500">{item.bulanTahun}</span>
                            </td>
                            <td className="px-4 py-4 text-center">
                               <span className="px-2.5 py-1 bg-slate-100 text-slate-600 rounded-lg text-[10px] font-bold whitespace-nowrap uppercase">
                                  {item.periodeLaporan}
                               </span>
                            </td>
                            <td className="px-4 py-4 text-center">
                               <div className="inline-flex items-center gap-1.5 px-3 py-1 bg-slate-50 border border-slate-100 rounded-lg text-[10px] font-bold">
                                  <span className="text-blue-600">L: {item.pmLaki || 0}</span>
                                  <span className="text-slate-300 font-normal">|</span>
                                  <span className="text-rose-500">P: {item.pmPerempuan || 0}</span>
                               </div>
                            </td>
                            <td className="px-4 py-4 text-center">
                               <span className="inline-block min-w-[32px] px-2 py-1 bg-indigo-600 text-white rounded-lg text-xs font-black shadow-sm">
                                  {item.totalPm}
                               </span>
                            </td>
                            <td className="px-6 py-4">
                               <p className="text-[11px] text-slate-500 line-clamp-1 max-w-[200px]" title={item.keterangan}>
                                  {item.keterangan || <span className="text-slate-300 italic">Tidak ada catatan</span>}
                               </p>
                            </td>
                            <td className="px-4 py-4 text-center">
                               {item.pdfData ? (
                                 <button onClick={()=>openPdf(item.pdfData)} className="p-1.5 text-indigo-600 hover:bg-indigo-100 rounded-lg transition-all" title="Lihat PDF">
                                   <FileText size={18} />
                                 </button>
                               ) : (
                                 <span className="text-[10px] text-slate-300 font-bold italic">-</span>
                               )}
                            </td>
                            <td className="px-6 py-4 text-right sticky right-0 bg-white group-hover:bg-indigo-50/30 transition-colors shadow-[-10px_0_15px_-10px_rgba(0,0,0,0.05)] sm:shadow-none">
                               <div className="flex items-center justify-end gap-1">
                                  <button onClick={()=>{setEditId(item.id); setForm({...item}); setActiveTab('input')}} className="p-2 text-slate-400 hover:text-indigo-600 hover:bg-white rounded-lg transition-all">
                                     <Edit3 size={16} />
                                  </button>
                                  <button onClick={()=>handleDelete(item.id)} className="p-2 text-slate-400 hover:text-rose-600 hover:bg-white rounded-lg transition-all">
                                     <Trash2 size={16} />
                                  </button>
                               </div>
                            </td>
                         </tr>
                       ))}
                    </tbody>
                 </table>
               </div>
               {filteredData.length === 0 && (
                 <div className="py-20 text-center">
                    <Search className="mx-auto text-slate-200 mb-2" size={40} />
                    <p className="text-[10px] font-bold uppercase tracking-widest text-slate-400">Data Kosong</p>
                 </div>
               )}
            </div>
          </div>
        )}
      </main>

      {/* Floating Bottom Nav */}
      <nav className="fixed bottom-6 left-1/2 -translate-x-1/2 w-[260px] bg-white border border-slate-200 p-1.5 rounded-2xl shadow-2xl flex items-center z-50">
        <button 
          onClick={()=>{setEditId(null); setForm({ unitPelayanan: '', bulanTahun: '', periodeLaporan: '', pmLaki: '', pmPerempuan: '', totalPm: 0, keterangan: '', pdfData: null, pdfName: '' }); setActiveTab('input');}} 
          className={`flex-1 flex items-center justify-center gap-2 py-2.5 rounded-xl transition-all ${activeTab === 'input' ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-100' : 'text-slate-400 hover:text-slate-600'}`}
        >
          <Plus size={20} />
          <span className="text-[10px] font-bold uppercase tracking-widest">{editId ? 'Edit' : 'Tambah'}</span>
        </button>
        <button 
          onClick={()=>setActiveTab('history')} 
          className={`flex-1 flex items-center justify-center gap-2 py-2.5 rounded-xl transition-all ${activeTab === 'history' ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-100' : 'text-slate-400 hover:text-slate-600'}`}
        >
          <LayoutGrid size={20} />
          <span className="text-[10px] font-bold uppercase tracking-widest">Data</span>
        </button>
      </nav>

      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        body { 
          background-color: #F8FAFC; 
          font-family: 'Plus Jakarta Sans', sans-serif;
          letter-spacing: -0.01em;
        }
        ::-webkit-scrollbar { height: 6px; width: 6px; }
        ::-webkit-scrollbar-thumb { background: #E2E8F0; border-radius: 10px; }
        ::-webkit-scrollbar-track { background: transparent; }
        .line-clamp-1 {
          display: -webkit-box;
          -webkit-line-clamp: 1;
          -webkit-box-orient: vertical;
          overflow: hidden;
        }
      `}</style>
    </div>
  );
}